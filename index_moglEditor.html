<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/mogl3d_styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.159.0/build/three.module.min.js"
            }
        }
    </script>
    <script src="./plugins/mogl3dEditor_UMD.js" type="module"></script>
</head>
<body>
    
    <div class="content">
    
        <h1>Mogl3D Editor</h1>
        <div id="editor" class="mogl3d"></div>

        <div>
            <h3>Text output: <button id='publish-button'>Publish</button></h3>
            <div id="text-output"></div>
        </div>
        
        <div>
            <h3>HTML output: <button id='data-button'>Data</button></h3>
            <pre id="html-output" class="html-output"></pre>
        </div>
    
    </div>
    <script type="module">
        import { ThreeModules } from './plugins/threeModules.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js';
        import * as THREE from 'three';

        let fileDatas = [];
        let outputCodes = null;
        let datas = null;
        let models_ = null;
        const editorElement = document.getElementById('editor');
        const myEditor = new MOGL3D( editorElement, {
            // actions:[
            //     'italic',
            //     'bold',
            //     'fontMenu',
            // ],
            onChange: function ( html, models ) {
                datas = html;
                if( models ) models_ = models;
                // document.getElementById('html-output').textContent = html;
            },
            plugins: [{
                'threeModules': ThreeModules,
            }],
            on3DLoad: function( obj, num ) {
                    // console.log('obj: ', obj);
                }
            });    
    
            const textOutputArea = document.querySelector('#text-output'); 
            const htmlOutputArea = document.querySelector('#html-output');
            const publishBtn = document.querySelector('#publish-button');
            const mogl3dContent = document.querySelector('.mogl3d-content');

            publishBtn.addEventListener('click', e => {

                let models = myEditor.getModels();
                
                textOutputArea.innerHTML = mogl3dContent.innerHTML;

                if( models ) {

                    models.map( model => {

                        for( let item in model ) {
                        
                            let node = textOutputArea.querySelector(`[title="${item}"]`);
                            if( node.firstChild ) node.removeChild( node.firstChild );
                        
                            let obj = model[item].clone();
                            let threeModules = new ThreeModules({
                                    editor: document.querySelector('#editor')
                                });
                            
                            threeModules.init( node, obj );
                        }
                    })

                }
                
            });

            document.getElementById('data-button').addEventListener('click', e => {
                
                // let models = myEditor.getModels();
                
                const files = myEditor.getFiles();
                let editorData = document.createElement('div');
                editorData.innerHTML = mogl3dContent.innerHTML;

                if( files ) {

                    let promises = files.map( file => {

                        return new Promise((resolve) => {

                            if( file.three ) {

                                let node = editorData.querySelector(`[title="${file.className}"]`);
                                let parentNode = node.parentNode;
                                parentNode.className = file.className;

                                while (parentNode.firstChild) {
                                    parentNode.removeChild(parentNode.firstChild);
                                }

                                resolve({
                                    'data': file,
                                    'code': editorData.innerHTML
                                });

                            } else {
                                
                                let className = file.className;
                                let node = editorData.querySelector(`.${className}`);
                                
                                while( node.firstChild ) {
                                    node.removeChild( node.firstChild );
                                }

                                resolve({
                                    'data': file,
                                    'code': editorData.innerHTML
                                });
                            
                            }

                        });

                    });

                    Promise.all( promises )
                        .then( results => {

                            results.forEach( res => {

                                if( res ) {
                                    fileDatas.push( res );
                                    outputCodes = res.code;
                                }

                            });

                            // to transfer server
                            console.log(`output Code: ${ outputCodes }, fileDatas: ${ fileDatas }`)

                        })
                        .catch( err => {

                            console.error( err );
                        
                        });

                } else {

                    // to transfer server
                    console.log('No files, just text datas: ', editorData.innerHTML )

                }

            })

    </script>

</body>
</html>